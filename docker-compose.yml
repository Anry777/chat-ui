# For development only
# Set MONGODB_URL=mongodb://localhost:27017 in .env.local to use this container
services:
  mongodb:
    image: mongo:8
    hostname: mongodb
    ports:
      - ${LOCAL_MONGO_PORT:-27017}:27017
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet --eval 'try { rs.status().ok } catch(e) { rs.initiate({_id:\"rs0\",members:[{_id:0,host:\"mongodb:27017\"}]}).ok }' | grep -q 1"
        ]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 10s
    volumes:
      - mongodb-data:/data/db
    restart: unless-stopped

  app:
    build:
      context: .
      args:
        INCLUDE_DB: "false"
    ports:
      - ${APP_PORT:-3000}:3000
    env_file:
      - .env.local
    environment:
      ORIGIN: http://10.1.2.125:3000
      PROTOCOL_HEADER: x-forwarded-proto
      MONGODB_URL: ${CHATUI_MONGODB_URL:-mongodb://mongodb:27017/?replicaSet=rs0}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-chat-ui}
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  mongo-express:
    image: mongo-express:1.0.2-20
    profiles:
      - tools
    ports:
      - ${MONGO_EXPRESS_PORT:-8081}:8081
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017/?replicaSet=rs0
    depends_on:
      mongodb:
        condition: service_healthy

volumes:
  mongodb-data:
